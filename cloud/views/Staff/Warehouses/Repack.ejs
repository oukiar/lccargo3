<!DOCTYPE html><html>    <head>		        <meta http-equiv="content-type" content="text/html;charset=UTF-8" />        <meta charset="utf-8" />        <title>LC Cargo</title>        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />        <meta content="" name="description" />        <meta content="" name="author" /> 	   <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=VT323">	 	    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Jura&amp;subset=all">       	   <!--ADMIN REQUIREMENTS-->     <% include ../../generals/ultraAdmin.ejs %>	            <script src="/cod/js/common.js"></script>        <script src="/cod/js/moment.js"></script>        <script src="/cod/js/ejs_production.js"></script>        <script src="/cod/js/jquery-1.11.2.min.js"></script>        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css" />        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>        <script src="http://yui.yahooapis.com/3.6.0/build/yui/yui-min.js"></script>        <script src="//www.parsecdn.com/js/parse-1.4.2.min.js"></script>        <script src="/cod/js/jspdf.min.js"></script>        <script src="/cod/js/base64.min.js"></script>        <script type="text/javascript" src="/cod/js/jquery.qrcode.js"></script>        <script type="text/javascript" src="/cod/js/qrcode.js"></script>        <style>        .boxes_table tbody td        {            font-family: Tahoma;            font-size: 14px;            color: #ffffff;        }        </style>    </head>    <!-- END HEAD -->    <!-- BEGIN BODY -->    <body>		<!--START TOPBAR-->		 <% include ../../generals/topbar.ejs %>        <!-- START CONTAINER -->        <div class="page-container row-fluid">        <!-- SIDEBAR - START -->        <!--  SIDEBAR - END -->	        <!-- START CONTENT -->        <section class="wrapper" style='display:inline-block;width:100%;'>        <div class='col-lg-12 col-md-12 col-sm-12 col-xs-12'>        <div class="page-title">		 <% include labelsMenu.ejs %>         <h1 class="title" style="font-family: 'VT323', serif; font-size:50px; padding-left:13px;">Warehouse - Repack</h1>  	  	 <div id="content" class="container">	  			 		           <div class="row">	  	   <div class="col-lg-12 col-md-12 container">	  	   <div class="col-md-6 col-xs-6">		   </div>						  	   <div class="col-md-6 col-xs-6" style="margin-top:3px;">		   <div style="float:right">			   Search client: <input id="txt_name" name="txt_name">           </div>           </div>				     	       <div class="panel"> 	       <div class="panel-body">           <ul id="list"> 	       <table>               <div id="repack_content" name="repack_content" >		    <!--<button id="btn_index">Index</button>-->           </div>           </table>  	       </ul>  	       </div>  	       </div>		   </div>		   </div>		   </fieldset>	  			  		    </div>            </div>            </div>            </section>            <!-- END CONTENT -->            </div><!-- END CONTAINER -->            <!-- LOAD FILES AT PAGE END FOR FASTER LOADING -->            <%include ../../generals/endFiles.ejs%>            <!-- modal end -->        <div id="openModal" class="modalDialogB">           <div>           <a href="#close" title="Close" class="closeB">X</a>           <div id="repack_form">           </div>           </div>        </div>        <!-- MODAL DE RESULT -->    <div id="openModalResult" class="modalDialog">                <div>                <a href="#close" title="Close" class="close">X</a>                <div id="modalmessage" style="margin-left:21%;">                <img src="/web/img/icons/loader_grey.gif">                </div>        </div>    </div>        <!--MODAL PARA MOSTAR BOXES-->    <div id="openModalB" class="modalDialog">        <div>            <a href="#close" title="Close" class="closeB">X</a>            <div id="receipt_boxes">                <h1 class="title" style="font-family: 'VT323', serif; font-size:50px; padding-left:13px;">Receipt# <font id="receiptBoxes"></font></h1>                <div style="overflow:scroll; height:400px; vertical-align: top;">                    <table id="boxes_table" name="boxes_table" class="table table-bordered">                        <thead>                            <tr>                                <td>                                    Check                                </td>                                <td>                                    Length                                </td>                                <td>                                    Width                                </td>                                <td>                                    Height                                </td>                                <td>                                    Box Id                                </td>                                <td>                                    Weight                                </td>                            </tr>                        </thead>                        <tbody>                        </tbody>                    </table>                </div>                <a href="#close" id="btn_doneboxes" class="pure-button pure-button-primary">Done boxes selection</a>                <!--<a>Select all</a>-->            </div>        </div>    </div>	    <div id="openModalC" class="modalRPBoxes">        <div>            <a href="#close" title="Close" class="closeB">X</a>            <div id="confirmation_boxes">                            </div>            <br>            <a href="#close" id="btn_confirmrepack" class="pure-button pure-button-primary">Confirm repack</a>        </div>    </div>    <script>            var openedreceipt = "-1";             Parse.initialize("XEPryFHrd5Tztu45du5Z3kpqxDsweaP1Q0lt8JOb", "MDhb1hBngr2tx2v9TjyzoUhMcOFeWGJ56TWvChqi");    /* GLOBAL USER */    var user;    /* OBTENCION Y ALMACENAMIENTO DEL CURRENT USER PARA USARSE CLIENTSIDE */    var query = new Parse.Query("User");        query.descending('createdAt');    query.include("Company");        query.get("<%= user.id%>", {        success:             function(object)            {                /* SAVE USER FOR FUTURE OPERATIONS */                user = object;                            }        });    /* ESTA VARIABLE ALMACENA EL OBJECTID DEL USUARIO SELECCIONADO */    usrID = -1;        /* THE WAREHOUSE FOR THE SELECTED BOXES */    var currentWareHouse;  	$( "#txt_name" ).autocomplete({source: []});        $("input[name=txt_name]").keydown(function(e) {        var code = e.keyCode || e.which;        if (code === 9) {              e.preventDefault();                        if($("#txt_name").val().length <= 1)                return;            			var myval = $("#txt_name").val();                        var query = new Parse.Query("Clients");            query.descending('createdAt');            query.equalTo("Company", {__type: "Pointer", className: "Companies", objectId: user.get("Company").id} );            /*query.contains("name_lower", myval);*/            /*query.matches("Name", myval, 'i');*/            query.startsWith("Name", myval.toUpperCase());                        query.find({                success:                     function(results)                    {                        var newresult = [];                                                if(results.length > 0)                        {                            $("#txt_name").val(results[0].get("Name") );                            usrID = results[0].id;                            update_table_repack();                        }                    }                });                    }    });        $("#txt_name").keyup(		function(e){                                    if($("#txt_name").val().length <= 2)                return;            			var myval = $("#txt_name").val();                        var query = new Parse.Query("Clients");            query.descending('createdAt');            query.equalTo("Company", {__type: "Pointer", className: "Companies", objectId: user.get("Company").id} );            /*query.contains("name_lower", myval);*/            /*query.matches("Name", myval, 'i');*/            query.startsWith("Name", myval.toUpperCase());                        query.find({                success:                     function(results)                    {                        var newresult = [];                                                for(i in results)                            newresult.push({label:results[i].get("Name"), idx:results[i].id});                                                    $("#txt_name").autocomplete({source: newresult});                           $("#txt_name").trigger("keydown");                    }                });        });        $("#btn_doneboxes").click(function(){                                                var checkboxes = document.getElementsByName("boxitems");                                var selected_boxes = [];                                for(i in checkboxes)                {                    if(checkboxes[i].checked)                    {                        selected_boxes.push(JSON.parse(checkboxes[i].id));                    }                }                                if(selected_boxes.length > 0)                    repack_receipts[openedreceipt] = selected_boxes;                                update_totalboxes();                update_boxestorepack(selected_boxes);                                });        function update_boxestorepack(selected_boxes)        {            q = new Parse.Query("Receipts");            q.get(openedreceipt, {                success:                     function(receipt)                    {                        $("#staterepack-" + openedreceipt).html(selected_boxes.length.toString() + "/" + receipt.get("TotalBoxes").toString() );                    }                });                    }        function update_totalboxes()        {            var count = 0;                        for(i in repack_receipts)                count += repack_receipts[i].length;                        $("#boxes_text").html("Selected boxes for repack: " + count);        }                $("#btn_confirmrepack").click(function(){                            /* GUARDAR LA BODEGA DE LA PRIMER CAJA SELECCIONADA */                var queryware = new Parse.Query("Receipts");                queryware.include("Warehouse");                var receiptID;                                for(i in repack_receipts)                {                    receiptID = i;                    break;                }                                queryware.get(receiptID, {                        success:                            function(obj)                            {                                /*alert(obj.get("Warehouse") );*/                                currentWareHouse = obj.get("Warehouse");                            }                    });                                /*$("#Warehouse").val();*/                            var repack_text = "Repack detail:\n\n";                            for(i in repack_receipts)                {                    repack_text += "Receipt ID: " + repack_receipts[i][0]["Receipt"] + "\n";                                        for(j in repack_receipts[i])                    {                        repack_text += "---- Box: " + repack_receipts[i][j]["Num"] + "\n";                    }                                        repack_text += "\n";                }                /* INSERT REPACK FORM */                $.post("/getrendered",                        {                            document: "Staff/Warehouses/repack_partitions/RepackForm"                        },                        function(result)                        {                            $("#repack_content").replaceWith(result);                            fillDestinations(usrID);                            $("#InternalNotes").val(repack_text);                            var q = new Parse.Query("Clients");                            q.equalTo("objectId", usrID);                            q.first({success:function(client){                                    /* DEFAULT SHIPPER AND CONSIGNEE SET TO CLIENT */                                    $("#Shipper").val(client.get("Name") );                                    shipperID = usrID;                                    $("#Consignee").val(client.get("Name") );                                    consigneeID = usrID;                                }});                        }                    );                                return true;            });        function fillDestinations(consigneID)        {            consigneeID = consigneID;                                    /* GET THE CLIENT OBJECT, WE NEED THE DESTINATIONS */            var query = new Parse.Query("Clients");            query.get(consigneeID, {                success:                     function(object)                    {                        /*destinations = object.get("Destinations");*/                                                var query = new Parse.Query("Destinations");                        query.equalTo("Client", {__type: "Pointer", className: "Clients", objectId: object.id});                                                query.find({success:function(results){                                    country = document.getElementById("Country");                                    country.options.length = 0;                                                                        /* DESTINATIONS */                                    for(i in results)                                    {                                        country.options[country.options.length] = new Option(results[i].get("Alias"), results[i].get("Alias"));                                    }                                                                        /* COUNTRY */                                    if(typeof(object.get("Country")) != "undefined" )                                        country.options[country.options.length] = new Option(object.get("Country"), object.get("Country"));                                                                        /* CUSTOM DESTINATION */                                    country.options[country.options.length] = new Option("Custom", "Custom");                                                                        $("#Country").change(function(){                                            if($("#Country").val() == "Custom")                                            {                                                $("#Country").replaceWith("<input type='text' class='input-5' id='Country'>");                                            }                                        });                                }                            });                        /* FILL THE WAREHOUSES ON THE REPACK FORM */                        var query = new Parse.Query("Cellars");                        query.equalTo("Company", {__type: "Pointer", className: "Companies", objectId: user.get("Company").id} );                        query.descending('createdAt');                        query.find({                            success:                                function(results)                                {                                    for(i in results)                                    {                                        /*WAREHOUSE FILTER*/                                        wareselect = document.getElementById("Warehouse");                                        wareselect.options[wareselect.options.length] = new Option(results[i].get("Name"), results[i].id);                                    }                                }                            });                                            }                });        }                                        function update_table_repack()        {            /*  TEST FOR USE EJS ON THE CLIENTSIDE            var query = new Parse.Query("Warehouses");            query.descending('createdAt');            query.equalTo("Consignee", {__type: "Pointer", className: "Clients", objectId: usrID});            query.find({                success:                     function(results)                    {                        var html = new EJS({url: '/web/Staff/Warehouses/Repack/RepackTable.ejs'}).render(results);                        alert(html);                    }                });                        return;*/                        if($("#warehousefilter").val() == "All" || typeof $("#warehousefilter").val() == "undefined")                conditions = {                                "equalTo":                                 {                                    "Status":"Received",                                    Company:{__type: "Pointer", className: "Companies", objectId: user.get("Company").id}                                }                            };            else                conditions = {                                "equalTo":                                 {                                    Status:"Received",                                     Warehouse:{__type: "Pointer", className: "Cellars", objectId: $("#warehousefilter").val()},                                    Company:{__type: "Pointer", className: "Companies", objectId: user.get("Company").id}                                }                            };                            data = {                    cols:   /*Columnas definidas FIELD:TITLE or FIELD:{FIELDNEEDED:FIELDTITLE}*/                         {                            "ReceiptNum":"",                            "RepackConsignee":{"Name":"", "Country":"Country"}, /*This is the sintax for return fields of pointers showed on table*/                            "RepackShipper":{"Name":""}, /*This is the sintax for return fields of pointers showed on table*/                            "ReceiptDate":"Date",                            "Destination":"",                            "Warehouse":{Name:""},                            "TotalBoxes":"",                            "PackedBoxes":"",                            "Transport":"",			                "Shipment":"",			                "Status":"",                            "objectId":"",                            "PackedBoxes":""                        },                                            /* AL PASAR EL PARAMETRO COLLECTION INDICAMOS QUE NECESITAMOS BUSQUEDA CON LISTA DE RESULTADOS */                    collection: "Receipts", /* COLLECCION PRINCIPAL */                    by: "Consignee",    /* CAMPO DE BUSQUEDA */                    value: {__type: "Pointer", className: "Clients", objectId: usrID},                                       conditions: conditions,                                        document: "Staff/Warehouses/repack_partitions/RepackTable"                };                            $.post("/getrendered", data,                function(result)                {                    $("#repack_content").replaceWith(result);                    /* FILL THE WAREHOUSES SELECT FILTER */                    var query = new Parse.Query("Cellars");                    query.equalTo("Company", {__type: "Pointer", className: "Companies", objectId: user.get("Company").id} );                    query.descending('createdAt');                    query.find({                        success:                            function(results)                            {                                for(i in results)                                {                                    /*WAREHOUSE FILTER*/                                    wareselect = document.getElementById("warehousefilter");                                    wareselect.options[wareselect.options.length] = new Option(results[i].get("Name"), results[i].id);                                }                            }                        });                });                                   }                $("#warehousefilter").change(function(){            if(usrID != -1)                update_table_repack();        });                /*CLIENT SELECCION FROM THE RESULT*/        $( "#txt_name" ).autocomplete({             select: 			 function( event, ui ){                                        usrID = ui.item.idx;                    update_table_repack();                }          });           repack_items = [];     repack_labels = [];         /* NEW, this holds the boxes selected for the repack process */    var repack_boxes = [];    var repack_receipts = {};             </script>            </body>	</html>
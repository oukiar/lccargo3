<%moment = require('cloud/moment')%><link rel="stylesheet" href="cod/css/styleWareHouse.css"><div id="repack_form"><form>    <input type="hidden" name="repack_items" id="repack_items" value"">    <div class="contNewLabel">    <div class="sectionNewLabel">		   <form method="POST" action='/addwarehouse'>		<div class="contNewLabel">        					<div class="colwrapper">					<div class="cont-2">												<div class="cont-5">							<div class="colwrapper-2">								<div class="cont-6">									<div class="cont-7"><p class="para-2"><span class="font-2">Receipt:</span></p></div>								</div>							</div>							<div class="colwrapper-3">								<div class="cont-8">									<input type="text" name="Receipt" id="Receipt" class="input" disabled>								</div>							</div>							<div class="colwrapper-4">								<div class="cont-9">									<div class="cont-10"><p class="para-3"><span class="font-3">Date:</span></p></div>								</div>							</div>							<div class="colwrapper-5">								<div class="cont-11">									<input type="text" name="ReceiptDate" id="ReceiptDate" value="<%= moment( new Date() ).format("MM[/]DD[/]YYYY")%>" class="input-2">								</div>							</div>							<div class="colwrapper-6">								<div class="cont-12">									<div class="cont-13"><p class="para-4"><span class="font-4">Agent:</span></p></div>								</div>							</div>							<div class="colwrapper-7">								<div class="cont-14">									<input type="text" name="Agent" id="Agent" class="input-3">								</div>							</div>						</div>						<div class="cont-15A">							<div class="cont-16">								<div class="colwrapper-8">									<div class="cont-17">										<!--<div class="cont-18"><p class="para-5"><span class="font-5">Ship type:</span></p></div>-->									</div>								</div>								<div class="colwrapper-9">									<div class="cont-19">										<div class="cont-20"><p class="para-6"><span class="font-6"> </span></p></div>									</div>								</div>							</div>							<div class="cont-21">								<div class="colwrapper-10">									<div class="cont-22">                            										<select id="Shipment" name="Shipment" class="input-4" >                                            <option value="Pending">Transportation</option>                                            <option value="Aereal">Aereal</option>                                            <option value="Terrestral">Terrestral</option>                                            <option value="Sea">Sea</option>                                        </select>									</div>								</div>																								<div class="colwrapper-15">									<div class="cont-28">	                                   <table>									   <tr><td style="position:relative; padding-right:8px; top:-4px;"><p class="para-4"><span class="font-4">Repack price:</span></p></td><td> <input type="number" name="repackPrice" id="repackPrice" class="input-15" size="3"> </td></tr></table>									</div>								</div>																	<div class="colwrapper-11">									<div class="cont-23">																		</div>								</div>								<div class="colwrapper-12">									<div class="cont-24">										<!-- CONSIGNEE-->                                        									</div>								</div>								<div class="colwrapper-13">									<div class="cont-25">																			</div>								</div>							</div>						</div>						<div class="cont-26">							<div class="colwrapper-14">								<div class="cont-27">                                        <select name="Transport" id="Transport" class="input-4">                                          <option value="-">Select Shipper</option>                                          <option value="UPS">UPS</option>                                          <option value="DHL">DHL</option>										  <option value="USPS">USPS</option>										  <option value="FEDEX">FEDEX</option>    								  </select>								</div>							</div>							<div class="colwrapper-15">								<div class="cont-28">                                    <input type="hidden" name="Warehouse" id="Warehouse">                                    <!--                                      <select name="Warehouse" id="Warehouse" class="input-4">                                                                            </select>                                    -->								</div>							</div>							<div class="colwrapper-16">								<div class="cont-29">                                    <select name="Country" id="Country" class="input-5">                                      <option value="-">-</option>                                      <option value="Antigua y Barbuda">Antigua y Barbuda</option>                                      <option value="Argentina">Argentina</option>                                      <option value="Aruba">Aruba</option>                                      <option value="Bahamas">Bahamas</option>                                      <option value="Barbado">Barbados</option>                                      <option value="Belize">Belize</option>                                      <option value="Bolivia">Bolivia</option>                                      <option value="Bonaire">Bonaire</option>                                      <option value="Brasil">Brasil</option>                                      <option value="Chile">Chile</option>                                      <option value="China">China</option>                                      <option value="Colombia">Colombia</option>                                      <option value="Costa Rica">Costa Rica</option>                                      <option value="Curacao">Curacao</option>                                      <option value="Dominica">Dominica</option>                                      <option value="Ecuador">Ecuador</option>                                      <option value="El Salvador">El Salvador</option>                                      <option value="Jamaica">Jamaica</option>                                      <option value="Espana">España</option>                                      <option value="Granada">Granada</option>                                      <option value="Guatemala">Guatemala</option>                                      <option value="Guayana Francesa">Guayana Francesa</option>                                      <option value="Guyana">Guyana</option>                                      <option value="Haiti">Haiti</option>                                      <option value="Honduras">Honduras</option>                                      <option value="Nicaragua">Nicaragua</option>                                      <option value="Panama">Panamá</option>                                      <option value="Paraguay">Paraguay</option>                                      <option value="Peru">Peru</option>                                      <option value="Puerto Rico">Puerto Rico</option>                                      <option value="Republica Dominicana">Republica Dominicana</option>                                      <option value="Saba">Saba</option>                                      <option value="Santa Lucia">Santa Lucia</option>                                      <option value="Sint Eustatius">Sint Eustatius</option>                                      <option value="St. Marteen">St. Marteen</option>                                      <option value="St. Vicent">St. Vicent</option>                                      <option value="Suriname">Suriname</option>                                      <option value="Trinidad">Trinidad</option>                                      <option value="U.S.A">U.S.A</option>                                      <option value="Venezuela">Venezuela</option>                                    </select>			                        </div>			                        </div>			                        </div>			 <div class="cont-30">			 <div class="colwrapper-17">			 <div class="cont-31">			 <div class="cont-32">			 <div class="colwrapper-18">			 <div class="cont-33">		     <div class="cont-34"><p class="para-7"><span class="font-7">Width:</span></p></div>		     </div>		     </div>		<div class="colwrapper-19">		<div class="cont-35">		<input type="text" name="Width" id="Width" class="input-9">        </div>        </div> <div class="colwrapper-20"> <div class="cont-36"> <div class="cont-37"><p class="para-8"><span class="font-8">Extra Cost:</span></p></div> </div> </div>						  <div class="colwrapper-21">					      <div class="cont-38">					      <input type="text" name="ExtraCost" id="ExtraCost" class="input-10">					      </div>					      </div>					  <div class="colwrapper-22">					  <div class="cont-39">				      <div class="cont-40"><p class="para-9"><span class="font-9">$</span></p></div>				      </div>				      </div>				      </div>				<div class="cont-41">				<div class="colwrapper-23">				<div class="cont-42">				<div class="cont-43"><p class="para-10"><span class="font-10">Height:</span></p></div>		        </div>		        </div>		 <div class="colwrapper-24">		 <div class="cont-44">	     <input type="text" name="Height" id="Height" class="input-11">	     </div>	     </div>	<div class="colwrapper-25">	<div class="cont-45">	<div class="cont-46"><p class="para-11"><span class="font-11">Lb</span></p></div>	</div>	</div>	     <div class="colwrapper-26">         <div class="cont-47">         <div class="cont-48"><p class="para-12"><span class="font-12">Invoice:</span></p></div>         </div>         </div><div class="colwrapper-27"><div class="cont-49"><input type="text" name="Invoice" id="Invoice" class="input-12"></div></div></div>          <div class="cont-50">          <div class="colwrapper-28">          <div class="cont-51">          <div class="cont-52"><p class="para-13"><span class="font-13">Length:</span></p></div>		  </div>		  </div>				    <div class="colwrapper-29">					<div class="cont-53">					<input type="text" name="Length" id="Length" class="input-13">					</div>					</div>	<div class="colwrapper-30">	<div class="cont-54">	<div class="cont-55"><p class="para-14"><span class="font-14">Lb</span></p></div>    </div>    </div>			  <div class="colwrapper-31">			  <div class="cont-56">			  <div class="cont-57"><p class="para-15"><span class="font-15">Value:</span></p></div>			  </div>			  </div>	 <div class="colwrapper-32">	 <div class="cont-58">	 <input type="text" name="Value" id="Value" class="input-14">	 </div>	 </div>			  <div class="colwrapper-33">			  <div class="cont-59">			  <div class="cont-60"><p class="para-16"><span class="font-16">$</span></p></div>			  </div>			  </div>			  </div>	 <div class="cont-61">	 <div class="colwrapper-34">	 <div class="cont-62">	 <div class="cont-63"><p class="para-17"><span class="font-17">Weight:</span></p></div>     </div>	 </div>		<div class="colwrapper-35">		<div class="cont-64">		<input type="text" name="Weight" id="Weight" class="input-15">		</div>		</div>		      <div class="colwrapper-36">		      <div class="cont-65">		      <div class="cont-66"><p class="para-18"><span class="font-18">Cf</span></p></div>		      </div>		      </div>		</div>		</div>				<div class="cont-67">		<div class="colwrapper-37">		<div class="cont-68">		<div class="cont-69"><p class="para-19"><span class="font-19">Zone:</span></p></div>	    </div>	    </div>		<div class="colwrapper-38">	<div class="cont-70">	<input type="text" name="Zone" id="Zone" class="input-16">    </div>	</div>	</div>	</div>										</div>							   <div class="cont-118">		       <div class="colwrapper-70">	<div class="cont-119">	<div class="cont-120"><p class="para-25"><span class="font-25">Content:</span></p></div>	</div>	</div>		<div class="colwrapper-71">		<div class="cont-121">		<div class="cont-122"><p class="para-26"><span class="font-26">General Notes:</span></p></div>		</div>		</div>		    <div class="colwrapper-72">			<div class="cont-123">			<div class="cont-124"><p class="para-27"><span class="font-27">Internal Notes:</span></p></div>			</div>			</div>		</div>									 <div class="cont-125">									<div class="colwrapper-73">		<div class="cont-126">		<textarea name="Content" id="Content" class="input-42" style="resize: none;"></textarea>		</div>	    </div>			<div class="colwrapper-74">			<div class="cont-127">		    <textarea name="GeneralNotes" id="GeneralNotes" class="input-43" style="resize: none;"></textarea>			</div>			</div>				<div class="colwrapper-75">				<div class="cont-128">				<textarea name="InternalNotes" id="InternalNotes" class="input-44" disabled style="resize: none;"></textarea>                                				</div>							</div>			</div>             </div>			 </div>                                				<div class="colwrapper-76">				 <div class="cont-129" >							<button id="btn_save" name="btn_save" type="button" style="border:none; background-color:transparent; width:64px; height:64px;"><img src="web/img/icons/save.png" alt="" class="img" ></button>				 </div>				    						   </div>			   </div>               </form>		 </div>        </div>	    		<script>        $("#btn_save").click(    function()    {               /*$("#repack_form").replaceWith("<div id='repack_form'><img src='/web/img/icons/loader_grey.gif'></div>");/*            /* GET THE COUNT FOR THIS NEW RECEIPT NUMBER */        var last_receipt_num = 1;        var query = new Parse.Query("Receipts");                    query.descending('ReceiptNum');                query.first().then(                function(object)                {                    last_receipt_num = object.get("ReceiptNum")+1;                                             var status = "Repack";                    var shipment = $("#Shipment").val();                                if(shipment == '-')                    {                        status = "NotProcessed";                    }                                                    /* NEW CODE FOR INPUT A NEW RECEIPT */                    var Receipts = Parse.Object.extend("Receipts");                    var receipt = new Receipts();                                        receipt.set("ReceiptNum", last_receipt_num);                    receipt.set("Status", status);                    receipt.set("ReceiptDate", new Date($("#ReceiptDate").val() ) );                    receipt.set("Agent", $("#Agent").val());                    receipt.set("Shipment", shipment);                    receipt.set("Consignee", {__type: "Pointer", className: "Clients", objectId: usrID});                    receipt.set("Transport", $("#Transport").val());                    /*receipt.set("Warehouse", {__type: "Pointer", className: "Cellars", objectId: $("#Warehouse").val()});*/                    receipt.set("Warehouse", currentWareHouse);                    receipt.set("Destination", $("#Country").val());                    receipt.set("Weight", $("#Weight").val());                    receipt.set("Volume", $("#Volume").val());                    receipt.set("Value", $("#Value").val());                    receipt.set("Zone", $("#Zone").val());                    receipt.set("Content", $("#Content").val());                    receipt.set("GeneralNotes", $("#GeneralNotes").val());                    receipt.set("InternalNotes", $("#InternalNotes").val());                    receipt.set("Price", $("#repackPrice").val());                    receipt.set("Company", {__type: "Pointer", className: "Companies", objectId: "<%= user.get("Company").id %>"});                    receipt.set("TotalBoxes", 1);                                        receipt.save({success: function(object){                                                                            /* SAVE THE BOX ... ALL REPACKS ONLY CONTAIN ONE BOX */                                                            var Boxes = Parse.Object.extend("Boxes");                            var box = new Boxes();                                                                                    box.set('Length', $("#Length").val());                            box.set('Width', $("#Width").val());                            box.set('Height', $("#Height").val());                            box.set('Weight', $("#Weight").val());                            box.set('Boxes', "1");                            box.set('Receipt', {__type: "Pointer", className: "Receipts", objectId:object.id });                            box.set('Num', "1/1");                                                        box.save();                                                                                    /*$("#repack_form").html("<a href='#close' id='btn_confirmrepack' class='pure-button pure-button-primary'>DONE</a>");                            */                            Insert({                                document: "Staff/Warehouses/repack_partitions/RepackResult",                                 itemid: "repack_form"});                        }});                                            /* Mark all boxes as repacked */                    for(i in repack_receipts)                    {                          var boxes_tosave = [];                                              for(box in repack_receipts[i])                        {                            var Boxes = Parse.Object.extend("Boxes");                            var newbox = new Boxes();                                                        newbox.id = repack_receipts[i][box]["objectId"];                            newbox.set("Status", "Repacked");                                                    boxes_tosave.push(newbox);                        }                                                /* SAVE ALL BOXES TOGETHER */                        Parse.Object.saveAll(boxes_tosave, {success:                                function(boxes_saved)                                {                                    /* CHECK IF THIS RECEIPT MUST BE MARKED AS REPACKED */                                    var queryboxes = new Parse.Query("Boxes");                                                    queryboxes.equalTo("Receipt", {__type: "Pointer", className: "Receipts", objectId: i});                                                                        queryboxes.find({                                        success:                                             function(resultboxes)                                            {                                                var repack = true;                                                                                                for(box in resultboxes)                                                {                                                    if(resultboxes[box].get("Status") != "Repacked" )                                                    {                                                        repack = false;                                                        break;                                                    }                                                }                                                                                                /* REPACK IS TRUE ONLY IF ALL BOXES HAS STATUS REPACKED */                                                if(repack)                                                {                                                                                                    qreceipt = new Parse.Query("Receipts");                                                                                                        qreceipt.get(i, function(obj){                                                            obj.set("Status", "Repacked");                                                            obj.set("PackedBoxes", obj.get("TotalBoxes") );                                                            obj.save();                                                        });                                                }                                                else                                                 {                                                       qreceipt = new Parse.Query("Receipts");                                                                                                        qreceipt.get(i, function(obj){                                                            obj.set("PackedBoxes", repack_receipts[i].length);                                                            obj.save();                                                        });                                                }                                            }                                        });                                }                            });                                            }                                $("#repack_content").replaceWith("<div id='repack_content'></div>");                    $("#txt_name").val("");                                        usrID = -1;                                    });                return;                var c=1;            var boxes = [];            do            {				if($("#" + "Weight-" + c.toString() ).val() == ""||					$("#" + "Boxes-" + c.toString() ).val() == "")					{						c += 1;						continue;					}                            boxes.push({                            'length': $("#" + "Length-" + c.toString() ).val(),                            'width': $("#" + "Width-" + c.toString() ).val(),                            'height': $("#" + "Height-" + c.toString() ).val(),                            'weight': $("#" + "Weight-" + c.toString() ).val(),                            'boxes': $("#" + "Boxes-" + c.toString() ).val() });                                c += 1;            }            while(typeof $("#" + "Length-" + c.toString() ).val() != "undefined");                                     /* agrega el campo 1/N que identifica el # de caja de todas en este receipt */            for(i in boxes)            {                var num = parseInt(i)+1;                boxes[i]["nbox"] = num.toString() + "/" + boxes.length.toString();            }                var status = "Repack";            var shipment = $("#Shipment").val();                if(shipment == '-')            {                status = "NotProcessed";            }                            /* SAVE THE REPACK */            SaveForm({                values:                    {                    Receipt: {__type: "Autoincrement"},                    ReceiptDate:    {__type: "Date", iso:$("#ReceiptDate").val() },                    Consignee: {__type:"Pointer", className: "Clients", objectId: usrID},                    Agent:          $("#Agent").val(),                    Shipment:       shipment,                    Transport:      $("#Transport").val(),                    Warehouse:      {__type: "Pointer", className: "Cellars", objectId: $("#Warehouse").val()},                    Country:        $("#Country").val(),                    TotalBoxes:     $("#Boxes").val(),                    Weight:         $("#Weight").val(),                    WeightVol:      $("#WeightVol").val(),                    Volume:         $("#Volume").val(),                    ExtraCost:      $("#ExtraCost").val(),                    Invoice:        $("#Invoice").val(),                    Value:          $("#Value").val(),                    Boxes:          JSON.stringify(boxes),                    LabelPacks:     JSON.stringify(repack_receipts),                    Zone:           $("#Zone").val(),                    Content:        $("#Content").val(),                    GeneralNotes:   $("#GeneralNotes").val(),                    InternalNotes:  $("#InternalNotes").val(),					Price:  $("#repackPrice").val() ,                    Status:      status,                    PackedBoxes:      0,                    Company: {__type: "Pointer", className: "Companies", objectId: "<%= user.get("Company").id %>"}                    },                                    collection: "Warehouses",                document: "Staff/Warehouses/repack_partitions/RepackResult",                params: {"message":"Repacket successfully"},                itemid: "repack_form",                /*pointed_by: {Warehouses:{"Repack":repack_items}},                pointed_update: {Warehouses:{"Status":"Repacked"}}*/                });                            /*Update the selected Warehouses discounting boxes and if is empty, as Repacked*/            for(i in repack_receipts)            {            				alert(JSON.stringify(repack_receipts[i]));				/*                Update({collection:"Warehouses",                             objectId: repack_items[i],                        values:{Status:"Repacked"}                    });                */            }                        $("#repack_form").replaceWith("<div id='repack_form'><img src='/web/img/icons/loader_grey.gif'></div>");        $("#repack_content").replaceWith("<div id='repack_content'></div>");        $("#txt_name").val("");                usrID = -1;               });        $("#ReceiptDate").datepicker();                                            var totalrows = 1;                                            $( "#btn_addbox" ).click(                function()                {                                    totalrows += 1;      var newrow = "<div class=\"cont-106\">";     var beforestr0 = "<div class=\"colwrapper-60\"><div class=\"cont-107\"><input type=\"text\" name=\"";     var beforestr1 = "<div class=\"colwrapper-61\"><div class=\"cont-107\"><input type=\"text\" name=\"";     var beforestr2 = "<div class=\"colwrapper-62\"><div class=\"cont-107\"><input type=\"text\" name=\"";     var beforestr3 = "<div class=\"colwrapper-63\"><div class=\"cont-107\"><input type=\"text\" name=\"";     var beforestr4 = "<div class=\"colwrapper-64\"><div class=\"cont-107\"><input type=\"text\" name=\"";     var afterstr = "\" class=\"input-35\"></div></div>";	             newrow += beforestr0 + "Length-" + totalrows.toString() + "\" id=\"Length-" + totalrows.toString() + afterstr;        newrow += beforestr1 + "Width-" + totalrows.toString() + "\" id=\"Width-" + totalrows.toString() + afterstr;        newrow += beforestr2 + "Height-" + totalrows.toString() + "\" id=\"Height-" + totalrows.toString() + afterstr;        newrow += beforestr3 + "Weight-" + totalrows.toString() + "\" id=\"Weight-" + totalrows.toString() + afterstr;        newrow += beforestr4 + "Boxes-" + totalrows.toString() + "\" id=\"Boxes-" + totalrows.toString() + afterstr;                                            newrow += "</div>";                               $(newrow).appendTo("#dyntable");                                    }            );		</script>